#!/bin/bash
# svc — simple service manager
# Usage: svc [action] [name]
#   svc              List all services with status
#   svc start NAME   Start a service (systemd or docker)
#   svc stop NAME    Stop a service
#   svc restart NAME Restart a service
#   svc logs NAME    Tail logs (journalctl or docker logs)
#   svc status NAME  Show detailed status of one service

set -uo pipefail

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

# ── Resolve: given a keyword, find the matching systemd unit or docker container ──
resolve() {
    local name="$1"
    local matches=()

    # Exact systemd match
    if systemctl cat "$name.service" &>/dev/null; then
        echo "systemd:$name"
        return
    fi

    # Exact docker match
    if docker inspect "$name" &>/dev/null 2>&1; then
        echo "docker:$name"
        return
    fi

    # Fuzzy systemd match
    while IFS= read -r unit; do
        unit="${unit%.service}"
        matches+=("systemd:$unit")
    done < <(systemctl list-units --type=service --all --no-pager --no-legend 2>/dev/null | awk '{print $1}' | grep -i "$name")

    # Fuzzy docker match
    while IFS= read -r cname; do
        matches+=("docker:$cname")
    done < <(docker ps -a --format '{{.Names}}' 2>/dev/null | grep -i "$name")

    if [ ${#matches[@]} -eq 0 ]; then
        echo ""
    elif [ ${#matches[@]} -eq 1 ]; then
        echo "${matches[0]}"
    else
        echo "multiple:${matches[*]}"
    fi
}

# ── List all services ──
do_list() {
    echo -e "${BOLD}Services on $(hostname)${NC}  ${DIM}$(date '+%H:%M')${NC}"
    echo ""

    # Systemd services — only show app/infra services, not system internals
    # This list is auto-generated from known running services. Edit to add new ones.
    local known_services=(
        nginx docker fail2ban auditd tailscaled node-exporter wazuh-agent
        security-alert-monitor cowrie
        marina-backend marina-frontend marina-backend-dev marina-frontend-dev
        energy-backbone-backend energy-backbone-frontend
        automl vereinsregister igmarkt riverpulse sss-wyc vibe-kanban
        inso-crawler claudecodeui cc-webhook whatsappclient service-inventory
        crif-mcp crif-multisystem-mcp destatis-mcp skyminder-mcp
    )

    echo -e "${YELLOW}Systemd Services${NC}"
    printf "  ${DIM}%-28s %s${NC}\n" "NAME" "STATUS"

    for unit in "${known_services[@]}"; do
        if systemctl is-active "$unit.service" &>/dev/null; then
            printf "  %-28s ${GREEN}%-8s${NC}\n" "$unit" "running"
        elif systemctl list-unit-files "$unit.service" --no-pager --no-legend 2>/dev/null | grep -q "$unit"; then
            printf "  %-28s ${RED}%-8s${NC}\n" "$unit" "stopped"
        fi
    done

    echo ""
    echo -e "${YELLOW}Docker Containers${NC}"
    printf "  ${DIM}%-28s %-10s %s${NC}\n" "NAME" "STATUS" "HEALTH"

    while IFS=$'\t' read -r cname cstatus chealth; do
        local state="${cstatus%% *}"
        if [ "$state" = "Up" ]; then
            local health_str=""
            if [ -n "$chealth" ] && [ "$chealth" != "-" ]; then
                if [[ "$chealth" == *"healthy"* ]]; then
                    health_str="${GREEN}healthy${NC}"
                else
                    health_str="${RED}$chealth${NC}"
                fi
            fi
            printf "  %-28s ${GREEN}%-10s${NC} %b\n" "$cname" "running" "$health_str"
        else
            printf "  %-28s ${RED}%-10s${NC}\n" "$cname" "stopped"
        fi
    done < <(docker ps -a --format '{{.Names}}\t{{.Status}}\t{{.Label "health"}}' 2>/dev/null | while IFS=$'\t' read -r n s _; do
        health=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}-{{end}}' "$n" 2>/dev/null)
        echo -e "$n\t$s\t$health"
    done | sort)

    echo ""
    echo -e "${DIM}Usage: svc start|stop|restart|logs|status <name>${NC}"
}

# ── Actions ──
do_action() {
    local action="$1"
    local name="$2"

    local resolved=$(resolve "$name")

    if [ -z "$resolved" ]; then
        echo -e "${RED}No service or container matching '$name'${NC}"
        return 1
    fi

    if [[ "$resolved" == multiple:* ]]; then
        echo -e "${YELLOW}Multiple matches for '$name':${NC}"
        local items="${resolved#multiple:}"
        for item in $items; do
            local type="${item%%:*}"
            local sname="${item#*:}"
            echo "  $sname ($type)"
        done
        echo ""
        echo "Be more specific."
        return 1
    fi

    local type="${resolved%%:*}"
    local sname="${resolved#*:}"

    case "$action" in
        start)
            echo -e "Starting ${BOLD}$sname${NC} ($type)..."
            if [ "$type" = "systemd" ]; then
                sudo systemctl start "$sname.service"
            else
                sudo docker start "$sname"
            fi
            echo -e "${GREEN}Done${NC}"
            ;;
        stop)
            echo -e "Stopping ${BOLD}$sname${NC} ($type)..."
            if [ "$type" = "systemd" ]; then
                sudo systemctl stop "$sname.service"
            else
                sudo docker stop "$sname"
            fi
            echo -e "${GREEN}Done${NC}"
            ;;
        restart)
            echo -e "Restarting ${BOLD}$sname${NC} ($type)..."
            if [ "$type" = "systemd" ]; then
                sudo systemctl restart "$sname.service"
            else
                sudo docker restart "$sname"
            fi
            echo -e "${GREEN}Done${NC}"
            ;;
        logs)
            if [ "$type" = "systemd" ]; then
                sudo journalctl -u "$sname.service" -f --no-pager -n 50
            else
                sudo docker logs "$sname" -f --tail 50
            fi
            ;;
        status)
            if [ "$type" = "systemd" ]; then
                systemctl status "$sname.service" --no-pager
            else
                docker inspect "$sname" --format \
                    'Name:    {{.Name}}
State:   {{.State.Status}}
Started: {{.State.StartedAt}}
Image:   {{.Config.Image}}
Ports:   {{range $p, $conf := .NetworkSettings.Ports}}{{$p}}→{{range $conf}}{{.HostIp}}:{{.HostPort}}{{end}} {{end}}
Health:  {{if .State.Health}}{{.State.Health.Status}}{{else}}n/a{{end}}'
            fi
            ;;
        *)
            echo "Unknown action: $action"
            echo "Usage: svc start|stop|restart|logs|status <name>"
            return 1
            ;;
    esac
}

# ── Main ──
if [ $# -eq 0 ]; then
    do_list
elif [ $# -eq 1 ]; then
    # Single arg: could be a name (show status) or help
    case "$1" in
        -h|--help|help)
            echo "svc — simple service manager"
            echo ""
            echo "Usage:"
            echo "  svc                  List all services"
            echo "  svc start <name>     Start a service"
            echo "  svc stop <name>      Stop a service"
            echo "  svc restart <name>   Restart a service"
            echo "  svc logs <name>      Tail logs"
            echo "  svc status <name>    Show detailed status"
            echo ""
            echo "Name matching is fuzzy — 'marina' matches marina-backend, marina-redis, etc."
            ;;
        *)
            do_action status "$1"
            ;;
    esac
elif [ $# -eq 2 ]; then
    do_action "$1" "$2"
else
    echo "Usage: svc [action] [name]"
    exit 1
fi
